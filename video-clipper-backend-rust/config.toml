# Video Clipper Backend Configuration
# This file contains all settings and optimizations for the backend
# Environment variables will override these values if set

[server]
# Port to listen on
port = 3000

# Directories
upload_dir = "uploads"
output_dir = "clips"

# Maximum file size in bytes (500MB default)
max_file_size = 524288000

[performance]
# Maximum concurrent clip processing tasks
# Set to 0 to auto-detect based on CPU count (recommended)
# Auto-detection: CPU count - 1, min 2, max 8
max_concurrent_clips = 0

# Upload buffer size in bytes (512KB for better I/O performance with large files)
# Larger buffers reduce system calls and improve throughput
upload_buffer_size = 524288

# Chunk logging interval (log progress every N chunks)
upload_log_interval = 100

[ffmpeg]
# Video encoding preset (ultrafast, superfast, veryfast, faster, fast, medium, slow, slower, veryslow)
# medium = good balance of quality and speed (recommended for quality)
# fast = faster encoding with good quality
preset = "medium"

# Constant Rate Factor (CRF) - quality setting
# Lower = better quality but larger files (18-28 range recommended)
# 20 = high quality, good for clips (recommended)
# 23 = good quality, faster encoding
crf = 20

# Video codec profile (baseline, main, high)
# high = best quality and compression efficiency
profile = "high"

# H.264 level (3.0, 3.1, 4.0, 4.1, 4.2, 5.0, 5.1, 5.2, etc.)
# 5.1 supports 4K video (up to 4096x2304) and high bitrates
# Required for 4K iPhone videos (3840x2160 or 2160x3840)
level = "5.1"

# Number of threads per clip encoding
# Set to 0 to auto-detect (half of CPU count, max 4)
# Auto-detection: CPU count / 2, min 1, max 4
threads_per_clip = 0

# Pixel format
pixel_format = "yuv420p"

# Tune settings (comma-separated: film, animation, grain, stillimage, fastdecode, zerolatency)
# Remove fastdecode/zerolatency for better quality, or use film/animation for content-specific optimization
tune = []

# Audio codec (copy = no re-encoding, fastest)
audio_codec = "copy"

# Input seeking optimization
# true = use input seeking (-ss before -i, faster but less accurate)
# false = use output seeking (-ss after -i, slower but more accurate)
use_input_seeking = true

# Additional FFmpeg flags
# Format: 
#   "+flag" = movflag (e.g., "+faststart")
#   "flag=value" = option with value (e.g., "avoid_negative_ts=make_zero")
#   "fflags=+flag" = fflag (e.g., "fflags=+genpts")
additional_flags = [
    "+faststart",
    "fflags=+genpts",
    "avoid_negative_ts=make_zero"
]

[optimization]
# Enable buffered file writes for uploads
enable_buffered_uploads = true

# Pre-allocate vectors for better memory performance
preallocate_vectors = true

# Minimum clip duration in seconds (clips shorter than this are skipped)
min_clip_duration = 3.0

# Logging verbosity (trace, debug, info, warn, error)
log_level = "info"

[limits]
# Maximum number of videos to keep in memory
max_cached_videos = 1000

# Timeout for clip generation in seconds (0 = no timeout)
clip_generation_timeout = 0

# Timeout for video upload in seconds (0 = no timeout)
upload_timeout = 0

# Default max clip length in seconds
default_max_clip_length = 15.0

# Cleanup task interval in seconds (how often to run cleanup)
cleanup_interval_seconds = 300

# Maximum age for files before cleanup in seconds
cleanup_max_age_seconds = 1800

[ffmpeg.advanced]
# Thread queue size for input (larger = better I/O)
thread_queue_size = 512

# Buffer size for encoding (e.g., "1M", "512k")
# Larger buffer allows better quality encoding
bufsize = "2M"

# Maximum bitrate (e.g., "4M", "2M")
# Higher bitrate = better quality (8M recommended for high quality clips)
maxrate = "8M"

# GOP size (Group of Pictures) for faster seeking
gop_size = 30

# Minimum keyframe interval
keyint_min = 30

# Default video codec fallback (if hardware acceleration not available)
default_video_codec = "libx264"

# VideoToolbox quality calculation settings
videotoolbox_quality_min = 50
videotoolbox_quality_max = 100
videotoolbox_crf_multiplier = 3.57

# Hardware encoder presets
# p4 = slower but better quality for NVENC
nvenc_preset = "p4"
nvenc_rc = "vbr"
# balanced = better quality/speed balance for QSV
qsv_preset = "balanced"
# balanced = better quality for AMF
amf_quality = "balanced"
amf_rc = "vbr_peak"

# Thread allocation settings
threads_when_1_2_clips_min = 2
threads_when_1_2_clips_max = 6
threads_when_3_4_clips_min = 1
threads_when_3_4_clips_max = 4
threads_when_many_clips_min = 1
threads_when_many_clips_max = 2

[server.defaults]
# Default filename when not provided
default_filename = "video.mp4"

# Default field name for multipart
default_field_name = ""

